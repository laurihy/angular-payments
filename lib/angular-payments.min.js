/*! angular-payments 21-08-2013 */
angular.module("angularPayments",[]),angular.module("angularPayments").factory("Common",[function(){var a={};return a.parseExpiry=function(a){var b,c,d,e;return a=a||"",a=a.replace(/\s/g,""),e=a.split("/",2),b=e[0],d=e[1],2===(null!=d?d.length:void 0)&&/^\d+$/.test(d)&&(c=(new Date).getFullYear(),c=c.toString().slice(0,2),d=c+d),b=parseInt(b,10),d=parseInt(d,10),{month:b,year:d}},a}]),angular.module("angularPayments").factory("Cards",[function(){var a=/(\d{1,4})/g,b=[{type:"maestro",pattern:/^(5018|5020|5038|6304|6759|676[1-3])/,format:a,length:[12,13,14,15,16,17,18,19],cvcLength:[3],luhn:!0},{type:"dinersclub",pattern:/^(36|38|30[0-5])/,format:a,length:[14],cvcLength:[3],luhn:!0},{type:"laser",pattern:/^(6706|6771|6709)/,format:a,length:[16,17,18,19],cvcLength:[3],luhn:!0},{type:"jcb",pattern:/^35/,format:a,length:[16],cvcLength:[3],luhn:!0},{type:"unionpay",pattern:/^62/,format:a,length:[16,17,18,19],cvcLength:[3],luhn:!1},{type:"discover",pattern:/^(6011|65|64[4-9]|622)/,format:a,length:[16],cvcLength:[3],luhn:!0},{type:"mastercard",pattern:/^5[1-5]/,format:a,length:[16],cvcLength:[3],luhn:!0},{type:"amex",pattern:/^3[47]/,format:/(\d{1,4})(\d{1,6})?(\d{1,5})?/,length:[15],cvcLength:[3,4],luhn:!0},{type:"visa",pattern:/^4/,format:a,length:[13,14,15,16],cvcLength:[3],luhn:!0}],c=function(a){var c,d,e;for(a=(a+"").replace(/\D/g,""),d=0,e=b.length;e>d;d++)if(c=b[d],c.pattern.test(a))return c},d=function(a){var c,d,e;for(d=0,e=b.length;e>d;d++)if(c=b[d],c.type===a)return c};return{fromNumber:function(a){return c(a)},fromType:function(a){return d(a)}}}]),angular.module("angularPayments").factory("_Format",["Cards",function(a){var b={},c=function(a){var b;return null!=a.prop("selectionStart")&&a.prop("selectionStart")!==a.prop("selectionEnd")?!0:("undefined"!=typeof document&&null!==document?null!=(b=document.selection)?"function"==typeof b.createRange?b.createRange().text:void 0:void 0:void 0)?!0:!1},d=function(b){var c,d,e,f,g,h,i;if(e=String.fromCharCode(b.which),c=angular.element(b.currentTarget),i=c.val(),d=a.fromNumber(i+e),f=(i.replace(/\D/g,"")+e).length,h=16,d&&(h=d.length[d.length.length-1]),!(f>=h)){if(!/^\d+$/.test(e))return b.preventDefault(),void 0;if(null==c.prop("selectionStart")||c.prop("selectionStart")===i.length)return g=d&&"amex"===d.type?/^(\d{4}|\d{4}\s\d{6})$/:/(?:^|\s)(\d{4})$/,g.test(i)?(b.preventDefault(),c.val(i+" "+e)):g.test(i+e)?(b.preventDefault(),c.val(i+e+" ")):void 0}},e=function(b){var d,e,f,g;d=angular.element(b.currentTarget),f=String.fromCharCode(b.which),/^\d+$/.test(f)&&(c(d)||(g=(d.val()+f).replace(/\D/g,""),e=a.fromNumber(g),e?g.length<=e.length[e.length.length-1]||b.preventDefault():g.length<=16||b.preventDefault()))},f=function(a){var b,c;return b=angular.element(a.currentTarget),c=b.val(),a.meta||8!==a.which||null!=b.prop("selectionStart")&&b.prop("selectionStart")!==c.length?void 0:/\d\s$/.test(c)?(a.preventDefault(),b.val(c.replace(/\d\s$/,""))):/\s\d?$/.test(c)?(a.preventDefault(),b.val(c.replace(/\s\d?$/,""))):void 0},g=function(b){var c,d,e,f;return(c=a.fromNumber(b))?(e=c.length[c.length.length-1],b=b.replace(/\D/g,""),b=b.slice(0,+e+1||9e9),c.format.global?null!=(f=b.match(c.format))?f.join(" "):void 0:(d=c.format.exec(b),null!=d&&d.shift(),null!=d?d.join(" "):void 0)):b};return _reFormatCardNumber=function(a){return setTimeout(function(){var b,c;return b=angular.element(a.target),c=b.val(),c=g(c),b.val(c)})},b.card=function(a){a.bind("keypress",e),a.bind("keypress",d),a.bind("keydown",f),a.bind("paste",_reFormatCardNumber)},_formatCVC=function(a){return $target=angular.element(a.currentTarget),digit=String.fromCharCode(a.which),/^\d+$/.test(digit)?(val=$target.val()+digit,val.length<=4?void 0:(a.preventDefault(),void 0)):(a.preventDefault(),void 0)},b.cvc=function(a){a.bind("keypress",_formatCVC)},_restrictExpiry=function(a){var b,d,e;return b=angular.element(a.currentTarget),d=String.fromCharCode(a.which),/^\d+$/.test(d)?c(b)?void 0:(e=b.val()+d,e=e.replace(/\D/g,""),e.length>6?(a.preventDefault(),void 0):void 0):(a.preventDefault(),void 0)},_formatExpiry=function(a){var b,c,d;return c=String.fromCharCode(a.which),/^\d+$/.test(c)?(b=angular.element(a.currentTarget),d=b.val()+c,/^\d$/.test(d)&&"0"!==d&&"1"!==d?(a.preventDefault(),b.val("0"+d+" / ")):/^\d\d$/.test(d)?(a.preventDefault(),b.val(""+d+" / ")):void 0):(a.preventDefault(),void 0)},_formatForwardExpiry=function(a){var b,c,d;return c=String.fromCharCode(a.which),/^\d+$/.test(c)?(b=angular.element(a.currentTarget),d=b.val(),/^\d\d$/.test(d)?b.val(""+d+" / "):void 0):void 0},_formatForwardSlash=function(a){var b,c,d;return c=String.fromCharCode(a.which),"/"===c?(b=angular.element(a.currentTarget),d=b.val(),/^\d$/.test(d)&&"0"!==d?b.val("0"+d+" / "):void 0):void 0},_formatBackExpiry=function(a){var b,c;if(!a.meta&&(b=angular.element(a.currentTarget),c=b.val(),8===a.which&&(null==b.prop("selectionStart")||b.prop("selectionStart")===c.length)))return/\d(\s|\/)+$/.test(c)?(a.preventDefault(),b.val(c.replace(/\d(\s|\/)*$/,""))):/\s\/\s?\d?$/.test(c)?(a.preventDefault(),b.val(c.replace(/\s\/\s?\d?$/,""))):void 0},b.expiry=function(a){a.bind("keypress",_restrictExpiry),a.bind("keypress",_formatExpiry),a.bind("keypress",_formatForwardSlash),a.bind("keypress",_formatForwardExpiry),a.bind("keydown",_formatBackExpiry)},function(a,c){if(!b[a])throw types=Object.keys(b),errstr='Unknown type for formatting: "'+a+'". ',errstr+='Should be one of: "'+types.join('", "')+'"';return b[a](c)}}]).directive("paymentsFormat",["$window","_Format",function(a,b){return{restrict:"A",link:function(a,c,d){b(d.paymentsFormat,c)}}}]),angular.module("angularPayments").factory("_Validate",["Cards","Common",function(a,b){var c=[].indexOf||function(a){for(var b=0,c=this.length;c>b;b++)if(b in this&&this[b]===a)return b;return-1},d=function(a){var b,c,d,e,f,g;for(d=!0,e=0,c=(a+"").split("").reverse(),f=0,g=c.length;g>f;f++)b=c[f],b=parseInt(b,10),(d=!d)&&(b*=2),b>9&&(b-=9),e+=b;return 0===e%10},e={};return e.cvc=function(b,d){var e,f;return/^\d+$/.test(b)?d?(e=b.length,c.call(null!=(f=a.fromType(d))?f.cvcLength:void 0,e)>=0):b.length>=3&&b.length<=4:!1},e.card=function(b){var e,f;return b=(b+"").replace(/\s+|-/g,""),/^\d+$/.test(b)?(e=a.fromNumber(b))?(f=b.length,ret=c.call(e.length,f)>=0&&(e.luhn===!1||d(b))):!1:!1},e.expiry=function(a){obj=b.parseExpiry(a),month=obj.month,year=obj.year;var c,d,e;return month&&year?/^\d+$/.test(month)?/^\d+$/.test(year)?parseInt(month,10)<=12?(2===year.length&&(e=(new Date).getFullYear(),e=e.toString().slice(0,2),year=e+year),d=new Date(year,month),c=new Date,d.setMonth(d.getMonth()-1),d.setMonth(d.getMonth()+1,1),d>c):!1:!1:!1:!1},function(a,b){if(!e[a])throw types=Object.keys(e),errstr='Unknown type for validation: "'+a+'". ',errstr+='Should be one of: "'+types.join('", "')+'"';return e[a](b)}}]).directive("paymentsValidate",["$window","_Validate",function(a,b){return{restrict:"A",require:"ngModel",link:function(a,c,d,e){var f=d.paymentsValidate;c.bind("blur",function(){e.$setValidity(f,b(f,c.val()))})}}}]),angular.module("angularPayments").directive("stripeForm",["$window","$parse","Common",function(a,b,c){return _getDataToSend=function(a){var b=["number","expMonth","expYear","cvc","name","addressLine1","addressLine2","addressCity","addressState","addressZip","addressCountry"],c=function(a){return a.replace(/([A-Z])/g,function(a){return"_"+a.toLowerCase()})},d={};for(i in b)d[c(b[i])]=angular.copy(a[b[i]]);return d.number=d.number.replace(/ /g,""),d},{restrict:"A",link:function(b,d,e){if(!a.Stripe)throw"stripeForm requires that you have stripe.js installed. Include https://js.stripe.com/v2/ into your html.";var f=angular.element(d);f.bind("submit",function(){expMonthUsed=b.expiryMonth?!0:!1,expYearUsed=b.expiryYear?!0:!1,expMonthUsed&&expYearUsed||(exp=c.parseExpiry(b.expiry),b.expMonth=exp.month,b.expYear=exp.year);var d=f.find("button");d.prop("disabled",!0),f.hasClass("ng-valid")&&a.Stripe.createToken(_getDataToSend(b),function(){var a=arguments;b.$apply(function(){b[e.stripeForm].apply(b,a)}),d.prop("disabled",!1)}),b.expiryMonth=expMonthUsed?b.expMonth:null,b.expiryYear=expYearUsed?b.expMonth:null})}}}]);