/*! angular-payments 03-06-2015 */
angular.module("angularPayments",[]),angular.module("angularPayments").factory("Common",[function(){var a={};return a.parseExpiry=function(a){var b,c,d,e;return a=a||"",a=a.replace(/\s/g,""),e=a.split("/",2),b=e[0],d=e[1],d&&2===d.length&&/^\d+$/.test(d)&&(c=(new Date).getFullYear(),c=c.toString().slice(0,2),d=c+d),b=parseInt(b,10),d=parseInt(d,10),{month:b,year:d}},a}]),angular.module("angularPayments").factory("Cards",[function(){var a=/(\d{1,4})/g,b=/(?:^|\s)(\d{4})$/,c=[{type:"maestro",pattern:/^(5018|5020|5038|6304|6759|676[1-3])/,format:a,inputFormat:b,length:[12,13,14,15,16,17,18,19],cvcLength:[3],luhn:!0},{type:"dinersclub",pattern:/^(36|38|30[0-5])/,format:a,inputFormat:b,length:[14],cvcLength:[3],luhn:!0},{type:"laser",pattern:/^(6706|6771|6709)/,format:a,inputFormat:b,length:[16,17,18,19],cvcLength:[3],luhn:!0},{type:"jcb",pattern:/^35/,format:a,inputFormat:b,length:[16],cvcLength:[3],luhn:!0},{type:"unionpay",pattern:/^62/,format:a,inputFormat:b,length:[16,17,18,19],cvcLength:[3],luhn:!1},{type:"discover",pattern:/^(6011|65|64[4-9]|622)/,format:a,inputFormat:b,length:[16],cvcLength:[3],luhn:!0},{type:"mastercard",pattern:/^5[1-5]/,format:a,inputFormat:b,length:[16],cvcLength:[3],luhn:!0},{type:"amex",pattern:/^3[47]/,format:/(\d{1,4})(\d{1,6})?(\d{1,5})?/,inputFormat:/^(\d{4}|\d{4}\s\d{6})$/,length:[15],cvcLength:[3,4],luhn:!0},{type:"visa",pattern:/^4/,format:a,inputFormat:b,length:[13,14,15,16],cvcLength:[3],luhn:!0}],d=function(a){var b,d,e;for(a=(a+"").replace(/\D/g,""),d=0,e=c.length;e>d;d++)if(b=c[d],b.pattern.test(a))return b},e=function(a){var b,d,e;for(d=0,e=c.length;e>d;d++)if(b=c[d],b.type===a)return b};return{fromNumber:function(a){return d(a)},fromType:function(a){return e(a)},defaultFormat:function(){return a},defaultInputFormat:function(){return b}}}]),angular.module("angularPayments").factory("_Format",["Cards","Common","$filter",function(a,b,c){var d={},e=function(a){return null!==a.prop("selectionStart")&&a.prop("selectionStart")!==a.prop("selectionEnd")?!0:document.selection?!0:!1},f=function(a){var b=String.fromCharCode(a.which);return!/^\d+$/.test(b)&&!a.metaKey&&0!==a.charCode&&!a.ctrlKey},g=function(b){var c,d,e,g,h,i,j;if(e=String.fromCharCode(b.which),c=angular.element(b.currentTarget),j=c.val(),d=a.fromNumber(j+e),g=(j.replace(/\D/g,"")+e).length,i=16,8!==b.which&&0!==b.which){if(d&&(i=d.length[d.length.length-1]),f(b))return void b.preventDefault();if(!(null!==c.prop("selectionStart")&&c.prop("selectionStart")!==j.length||(h=a.defaultInputFormat(),d&&(h=d.inputFormat),g>=i)))return h.test(j)?(b.preventDefault(),c.val(j+" "+e)):h.test(j+e)?(b.preventDefault(),c.val(j+e+" ")):void 0}},h=function(b){var c,d,f,g;return c=angular.element(b.currentTarget),f=String.fromCharCode(b.which),8!==b.which&&0!==b.which?/^\d+$/.test(f)?void(e(c)||(g=(c.val()+f).replace(/\D/g,""),d=a.fromNumber(g),d?g.length>d.length[d.length.length-1]&&b.preventDefault():g.length>16&&b.preventDefault())):void b.preventDefault():void 0},i=function(a){var b,c;return b=angular.element(a.currentTarget),c=b.val(),a.metaKey||8!==a.which||null!==b.prop("selectionStart")&&b.prop("selectionStart")!==c.length?void 0:/\d\s$/.test(c)&&!a.metaKey&&a.keyCode>=46?(a.preventDefault(),b.val(c.replace(/\d\s$/,""))):/\s\d?$/.test(c)?(a.preventDefault(),b.val(c.replace(/\s\d?$/,""))):void 0},j=function(b){var c,d,e,f;return(c=a.fromNumber(b))?(e=c.length[c.length.length-1],b=b.replace(/\D/g,""),b=b.slice(0,+e+1||9e9),c.format.global?null!==(f=b.match(c.format))?f.join(" "):void 0:(d=c.format.exec(b),null!==d&&d.shift(),null!==d?d.join(" "):void 0)):b},k=function(a){return setTimeout(function(){var b,c;return b=angular.element(a.target),c=b.val(),c=j(c),b.val(c)})},l=function(a){return null!==a&&void 0!==a?a.replace(/\s/g,""):a};d.card=function(a,b){a.bind("keypress",h),a.bind("keypress",g),a.bind("keydown",i),a.bind("paste",k),b.$parsers.push(l),b.$formatters.push(j)};var m=function(a){var b,c,d;if(b=angular.element(a.currentTarget),c=String.fromCharCode(a.which),8!==a.which&&0!==a.which){if(f(a))return void a.preventDefault();if(!e(b))return d=b.val()+c,d.length<=4?void 0:void a.preventDefault()}};d.cvc=function(a){a.bind("keypress",m)};var n=function(a){var b,c,d;return b=angular.element(a.currentTarget),c=String.fromCharCode(a.which),f(a)?void a.preventDefault():e(b)?void 0:(d=b.val()+c,d=d.replace(/\D/g,""),d.length>6?void a.preventDefault():void 0)},o=function(a){var b,c,d;return c=String.fromCharCode(a.which),f(a)?void a.preventDefault():(b=angular.element(a.currentTarget),d=b.val()+c,/^\d$/.test(d)&&"0"!==d&&"1"!==d?(a.preventDefault(),b.val("0"+d+" / ")):/^\d\d$/.test(d)?(a.preventDefault(),b.val(""+d+" / ")):void 0)},p=function(a){var b,c,d;return c=String.fromCharCode(a.which),f(a)?void 0:(b=angular.element(a.currentTarget),d=b.val(),/^\d\d$/.test(d)?b.val(""+d+" / "):void 0)},q=function(a){var b,c,d;return c=String.fromCharCode(a.which),"/"===c?(b=angular.element(a.currentTarget),d=b.val(),/^\d$/.test(d)&&"0"!==d?b.val("0"+d+" / "):void 0):void 0},r=function(a){var b,c;if(!(a.meta||a.metaKey||(b=angular.element(a.currentTarget),c=b.val(),8!==a.which||null!==b.prop("selectionStart")&&b.prop("selectionStart")!==c.length)))return/\d(\s|\/)+$/.test(c)?(a.preventDefault(),b.val(c.replace(/\d(\s|\/)*$/,""))):/\s\/\s?\d?$/.test(c)?(a.preventDefault(),b.val(c.replace(/\s\/\s?\d?$/,""))):void 0},s=function(a){if(null!==a){var d=b.parseExpiry(a),e=new Date(d.year,d.month-1);return c("date")(e,"MM/yyyy")}return null},t=function(a){if(null!==a){var d=b.parseExpiry(a),e=new Date(d.year,d.month-1);return c("date")(e,"MM / yyyy")}return null};return d.expiry=function(a,b){a.bind("keypress",n),a.bind("keypress",o),a.bind("keypress",q),a.bind("keypress",p),a.bind("keydown",r),b.$parsers.push(s),b.$formatters.push(t)},function(a,b,c){var e,f;if(!d[a])throw e=Object.keys(d),f='Unknown type for formatting: "'+a+'". ',f+='Should be one of: "'+e.join('", "')+'"';return d[a](b,c)}}]).directive("paymentsFormat",["$window","_Format",function(a,b){return{restrict:"A",require:"ngModel",link:function(a,c,d,e){b(d.paymentsFormat,c,e)}}}]),angular.module("angularPayments").factory("_Validate",["Cards","Common","$parse",function(a,b,c){var d=[].indexOf||function(a){for(var b=0,c=this.length;c>b;b++)if(b in this&&this[b]===a)return b;return-1},e=function(a){var b,c,d,e,f,g;for(d=!0,e=0,c=(a+"").split("").reverse(),f=0,g=c.length;g>f;f++)b=c[f],b=parseInt(b,10),(d=!d)&&(b*=2),b>9&&(b-=9),e+=b;return e%10===0},f={};return f.cvc=function(b,e,f,g){var h,i;if(!b)return!0;if(!/^\d+$/.test(b))return!1;var j;if(g.paymentsTypeModel){var k=c(g.paymentsTypeModel);j=k(f)}return j?(h=b.length,d.call(null!==(i=a.fromType(j))?i.cvcLength:void 0,h)>=0):b.length>=3&&b.length<=4},f.card=function(b,f,g,h){var i,j,k,l;h.paymentsTypeModel&&(k=c(h.paymentsTypeModel));var m=function(){k&&k.assign(g,null),f.$card=null};if(!b)return m(),!0;if(b=(b+"").replace(/\s+|-/g,""),!/^\d+$/.test(b))return m(),!1;if(i=a.fromNumber(b),!i)return m(),!1;f.$card=angular.copy(i),k&&k.assign(g,i.type);var n=16;switch(i.type){case"amex":n=15}return j=b.length,l=d.call(i.length,j)>=0&&b.length===n&&(i.luhn===!1||e(b))},f.expiry=function(a){var c,d,e;if(!a)return!0;e=b.parseExpiry(a),c=e.month,d=e.year;var f,g,h;return c&&d&&/^\d+$/.test(c)&&/^\d+$/.test(d)?parseInt(c,10)>12?!1:(2===d.length&&(h=(new Date).getFullYear(),h=h.toString().slice(0,2),d=h+d),g=new Date(d,c),f=new Date,g.setMonth(g.getMonth()-1),g.setMonth(g.getMonth()+1,1),g>f):!1},function(a,b,c,d,e){var g,h;if(!f[a])throw g=Object.keys(f),h='Unknown type for validation: "'+a+'". ',h+='Should be one of: "'+g.join('", "')+'"';return f[a](b,c,d,e)}}]).factory("_ValidateWatch",["_Validate",function(a){var b={};return b.cvc=function(b,c,d,e){e.paymentsTypeModel&&d.$watch(e.paymentsTypeModel,function(f,g){if(f!==g){var h=a(b,c.$modelValue,c,d,e);c.$setValidity(b,h)}})},function(a,c,d,e){return b[a]?b[a](a,c,d,e):void 0}}]).directive("paymentsValidate",["$window","_Validate","_ValidateWatch",function(a,b,c){return{restrict:"A",require:"ngModel",link:function(a,d,e,f){var g=e.paymentsValidate;c(g,f,a,e);var h=function(c){var d=b(g,c,f,a,e);return f.$setValidity(g,d),d?c:void 0};f.$formatters.push(h),f.$parsers.push(h)}}}]).directive("paymentsLength",[function(){return{require:"ngModel",link:function(a,b,c,d){d.$parsers.push(function(b){if("card"===c.paymentsLength){var e="",f="amex"===a.type?15:16;d.$viewValue&&(e=d.$viewValue.replace(/\s/g,"")),d.$setValidity("length",e.length>=f)}return b})}}}]),angular.module("angularPayments").directive("stripeForm",["$window","$parse","Common",function(a,b,c){var d=function(a){var b=["number","expMonth","expYear","cvc","name","addressLine1","addressLine2","addressCity","addressState","addressZip","addressCountry"],c=function(a){return a.replace(/([A-Z])/g,function(a){return"_"+a.toLowerCase()})},d={};for(var e in b)a.hasOwnProperty(b[e])&&(d[c(b[e])]=angular.copy(a[b[e]]));return d.number=(d.number||"").replace(/ /g,""),d};return{restrict:"A",link:function(b,e,f){if(!a.Stripe)throw"stripeForm requires that you have stripe.js installed. Include https://js.stripe.com/v2/ into your html.";var g=angular.element(e);g.bind("submit",function(){var e=b.expMonth?!0:!1,h=b.expYear?!0:!1;if(!e||!h){var i=c.parseExpiry(b.expiry);b.expMonth=i.month,b.expYear=i.year}var j=g.find("button");j.prop("disabled",!0),g.hasClass("ng-valid")?a.Stripe.createToken(d(b),function(){var a=arguments;b.$apply(function(){b[f.stripeForm].apply(b,a)}),j.prop("disabled",!1)}):(b.$apply(function(){b[f.stripeForm].apply(b,[400,{error:"Invalid form submitted."}])}),j.prop("disabled",!1)),b.expMonth=null,b.expYear=null})}}}]);